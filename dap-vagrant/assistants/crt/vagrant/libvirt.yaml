fullname: libvirt
description: Create a vagrant box with libvirt

dependencies:
- use: super.dependencies
- rpm: ['vagrant-libvirt']

dependencies_domain:
- rpm: ['vagrant-libvirt-doc']

args:
  name:
    use: common_args

  domain:
    flags:
    - -d
    - --domain
    help: 'This automatically starts domain'
    action: 'store_true'

files:
  libvirtsources: &libvirtsources
    source: .
run:
- setup_project_dir:
    from: $name
    on_existing: fail
    create_topdir: normalized
    topdir_normalized_var: basename
- log_i: 'Creating Vagrant-libvirt project $basename in $contdir ...'
- cl: cd "$contdir"
- cl_i: cp -r *libvirtsources "$basename"
- cl: cd "$basename"
- if defined $domain:
  - $vagrant_version~: $(rpm -q vagrant-libvirt --qf '%{version}')
  - log_i: "Copy 10-vagrant-libvirt-rules file so that libvirt domain is automatically started"
  - cl: pkexec cp /usr/share/vagrant/gems/doc/vagrant-libvirt-$vagrant_version/polkit/10-vagrant-libvirt.rules /usr/share/polkit-1/rules.d/
- cl_i: vagrant init
- cl_i: vagrant up
